import React, { useEffect, useState } from "react";

// Pokedex.jsx
// Single-file React component (Tailwind CSS assumed) that builds an interactive
// Pokédex for the first 50 Pokémon. Features:
// - Fetches first 50 Pokémon from PokeAPI
// - Shows animated sprites when available (Black/White animated sprites)
// - Search by name / ID and filter by type
// - Click a card to open a detail drawer/modal with larger animation and info
// - Clean, responsive grid layout with small interactions

export default function Pokedex() {
  const [pokemonList, setPokemonList] = useState([]);
  const [loading, setLoading] = useState(true);
  const [query, setQuery] = useState("");
  const [typeFilter, setTypeFilter] = useState("All");
  const [types, setTypes] = useState([]);
  const [selected, setSelected] = useState(null);
  const [error, setError] = useState(null);

  // color map for types (simple palette)
  const TYPE_COLORS = {
    normal: "bg-gray-300",
    fire: "bg-red-300",
    water: "bg-blue-300",
    electric: "bg-yellow-300",
    grass: "bg-green-300",
    ice: "bg-teal-200",
    fighting: "bg-orange-300",
    poison: "bg-purple-300",
    ground: "bg-yellow-200",
    flying: "bg-indigo-200",
    psychic: "bg-pink-300",
    bug: "bg-lime-300",
    rock: "bg-stone-300",
    ghost: "bg-violet-300",
    dragon: "bg-indigo-400",
    dark: "bg-stone-500",
    steel: "bg-slate-300",
    fairy: "bg-rose-200",
  };

  useEffect(() => {
    // Load the first 50 Pokemon
    async function load() {
      try {
        setLoading(true);
        const res = await fetch("https://pokeapi.co/api/v2/pokemon?limit=50&offset=0");
        if (!res.ok) throw new Error("Failed to fetch list");
        const listData = await res.json();

        // Fetch each detail in parallel
        const detailPromises = listData.results.map(async (p) => {
          const r = await fetch(p.url);
          if (!r.ok) throw new Error("Failed to fetch pokemon detail");
          const d = await r.json();

          // attempt to pick an animated sprite if present (generation V - Black/White)
          const animated = d.sprites?.versions?.["generation-v"]?.["black-white"]?.animated?.front_default;
          const frontDefault = d.sprites?.front_default;
          const officialArtwork = d.sprites?.other?.["official-artwork"]?.front_default;

          return {
            id: d.id,
            name: d.name,
            types: d.types.map((t) => t.type.name),
            height: d.height,
            weight: d.weight,
            animatedSprite: animated || frontDefault || officialArtwork,
            spriteStatic: frontDefault || officialArtwork,
            artwork: officialArtwork,
            raw: d,
          };
        });

        const details = await Promise.all(detailPromises);
        // sort by id just in case
        details.sort((a, b) => a.id - b.id);
        setPokemonList(details);

        // collect type set
        const typeSet = new Set();
        details.forEach((p) => p.types.forEach((t) => typeSet.add(t)));
        setTypes(["All", ...Array.from(typeSet).sort()]);

        setLoading(false);
      } catch (err) {
        console.error(err);
        setError(err.message);
        setLoading(false);
      }
    }

    load();
  }, []);

  // helpers
  const matches = (p) => {
    const q = query.trim().toLowerCase();
    if (q) {
      if (!(p.name.toLowerCase().includes(q) || String(p.id) === q)) return false;
    }
    if (typeFilter !== "All") {
      if (!p.types.includes(typeFilter)) return false;
    }
    return true;
  };

  const visible = pokemonList.filter(matches);

  return (
    <div className="p-6 min-h-screen bg-gradient-to-b from-white to-slate-50">
      <div className="max-w-6xl mx-auto">
        <header className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6">
          <h1 className="text-3xl font-extrabold">Pokédex — First 50</h1>

          <div className="flex gap-3 items-center">
            <input
              value={query}
              onChange={(e) => setQuery(e.target.value)}
              placeholder="Search by name or ID..."
              className="px-3 py-2 rounded-lg border outline-none shadow-sm w-60"
            />

            <select
              value={typeFilter}
              onChange={(e) => setTypeFilter(e.target.value)}
              className="px-3 py-2 rounded-lg border shadow-sm"
            >
              {types.map((t) => (
                <option key={t} value={t}>
                  {t === "All" ? "All types" : capitalize(t)}
                </option>
              ))}
            </select>

            <div className="text-sm text-slate-500">Showing {visible.length} / {pokemonList.length}</div>
          </div>
        </header>

        {loading ? (
          <div className="py-20 text-center text-slate-500">Loading Pokédex...</div>
        ) : error ? (
          <div className="py-10 text-center text-red-500">Error: {error}</div>
        ) : (
          <main>
            <section className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
              {visible.map((p) => (
                <article
                  key={p.id}
                  onClick={() => setSelected(p)}
                  className="group cursor-pointer relative bg-white rounded-2xl p-4 shadow hover:shadow-lg transition-shadow duration-200"
                >
                  <div className="flex items-center justify-between">
                    <div>
                      <div className="text-sm text-slate-400">#{String(p.id).padStart(3, "0")}</div>
                      <h2 className="capitalize text-xl font-semibold">{p.name}</h2>
                    </div>
                    <div className="w-20 h-20 flex items-center justify-center">
                      {/* sprite - animate on hover */}
                      <img
                        src={p.animatedSprite}
                        alt={p.name}
                        className="w-20 h-20 object-contain transition-transform duration-300 group-hover:scale-110"
                        onError={(e) => {
                          // fallback to static artwork
                          e.currentTarget.src = p.spriteStatic || p.artwork;
                        }}
                      />
                    </div>
                  </div>

                  <div className="mt-3 flex gap-2">
                    {p.types.map((t) => (
                      <span
                        key={t}
                        className={`capitalize px-2 py-1 text-xs font-medium rounded-full ${TYPE_COLORS[t] || "bg-slate-200"}`}
                      >
                        {t}
                      </span>
                    ))}
                  </div>

                  <div className="mt-3 text-sm text-slate-500">Click card for details</div>
                </article>
              ))}
            </section>

            {/* selected modal/drawer */}
            {selected && (
              <div className="fixed inset-0 z-50 flex items-end sm:items-center justify-center">
                <div className="absolute inset-0 bg-black/40" onClick={() => setSelected(null)} />
                <div className="relative w-full sm:max-w-3xl bg-white rounded-2xl p-6 shadow-2xl m-4">
                  <div className="flex gap-4">
                    <div className="w-48 flex items-center justify-center">
                      <img
                        src={selected.animatedSprite || selected.spriteStatic}
                        alt={selected.name}
                        className="w-40 h-40 object-contain"
                        onError={(e) => (e.currentTarget.src = selected.spriteStatic || selected.artwork)}
                      />
                    </div>
                    <div className="flex-1">
                      <div className="flex justify-between items-start">
                        <div>
                          <h3 className="text-2xl font-bold capitalize">{selected.name} <span className="text-slate-400 text-base">#{String(selected.id).padStart(3, "0")}</span></h3>
                          <div className="mt-2 flex gap-2">
                            {selected.types.map((t) => (
                              <span key={t} className={`capitalize px-2 py-1 text-sm rounded-full ${TYPE_COLORS[t] || "bg-slate-200"}`}>
                                {t}
                              </span>
                            ))}
                          </div>
                        </div>

                        <div>
                          <button
                            onClick={() => setSelected(null)}
                            className="px-3 py-2 rounded-md border shadow-sm"
                          >
                            Close
                          </button>
                        </div>
                      </div>

                      <div className="mt-4 grid grid-cols-2 gap-3 text-sm text-slate-600">
                        <div>
                          <div className="text-slate-400">Height</div>
                          <div>{selected.height / 10} m</div>
                        </div>
                        <div>
                          <div className="text-slate-400">Weight</div>
                          <div>{selected.weight / 10} kg</div>
                        </div>

                        <div className="col-span-2">
                          <div className="text-slate-400">Abilities</div>
                          <div className="flex gap-2 mt-1 flex-wrap">
                            {selected.raw.abilities.map((a) => (
                              <span key={a.ability.name} className="text-sm px-2 py-1 bg-slate-100 rounded">{a.ability.name}</span>
                            ))}
                          </div>
                        </div>

                        <div className="col-span-2 mt-2">
                          <div className="text-slate-400">Base stats</div>
                          <div className="mt-1 grid grid-cols-2 sm:grid-cols-3 gap-2">
                            {selected.raw.stats.map((s) => (
                              <div key={s.stat.name} className="text-sm">
                                <div className="text-slate-500 text-xs">{s.stat.name}</div>
                                <div className="font-medium">{s.base_stat}</div>
                              </div>
                            ))}
                          </div>
                        </div>

                      </div>
                    </div>
                  </div>
                </div>
              </div>
            )}

          </main>
        )}

        <footer className="mt-8 text-center text-slate-400 text-sm">Data & sprites from <a className="underline" href="https://pokeapi.co" target="_blank" rel="noreferrer">PokeAPI</a></footer>
      </div>
    </div>
  );
}

// small helper
function capitalize(s) {
  if (!s) return s;
  return s.charAt(0).toUpperCase() + s.slice(1);
}
